# Техническая документация

## Описание проекта
Проект представляет собой распределённую систему облачных вычислений, которая позволяет выполнять удалённые вычисления на предварительно зарегистрированных узлах (серверах). Система поддерживает передачу кода, данных, а также удалённое выполнение функций. 

Основные возможности:
- Регистрация удалённых функций.
- Выполнение удалённых задач.
- Параллельное распределённое выполнение `map`.
- Поддержка передачи Java-объектов и Clojure-кода.
- Балансировка нагрузки между серверами.
- Асинхронное выполнение задач с мониторингом их статуса.

---

## Архитектура
### Основные компоненты
1. **Сервер**
    - Принимает запросы на выполнение задач и регистрацию функций.
    - Управляет состоянием зарегистрированных функций и задач.
    - Отслеживает загрузку и активность узла.
2. **Клиент**
    - Инициирует выполнение задач и регистрирует функции на серверах.
    - Выбирает подходящий сервер для выполнения задачи.
    - Поддерживает параллельное выполнение задач через `parallel-map`.
3. **Файл конфигурации (`servers.edn`)**
    - Хранит информацию о зарегистрированных серверах: их ID, порты и текущую загрузку.

### Принцип работы
- Клиент отправляет запрос на сервер с кодом или данными для выполнения.
- Сервер принимает запрос, выполняет задачу или регистрирует функцию.
- Если задача требует выполнения на другом сервере, она перенаправляется.
- После завершения выполнения сервер отправляет результат клиенту.

---

## Серверная часть

### Основные функции
- **Регистрация удалённых функций**:
  ```clojure
  (register-remote-function name function)
  ```
  Регистрирует функцию с указанным именем.

- **Обработка задач**:
  ```clojure
  (job-handler req server-id)
  ```
  Выполняет задачу, переданную клиентом. Поддерживает выполнение Clojure-кода, Java-объектов и вызов зарегистрированных функций.

- **Балансировка нагрузки**:
  ```clojure
  (update-server-load server-id delta)
  ```
  Обновляет текущую загрузку сервера.

### Маршруты
- `/register-function` — регистрация функции.
- `/check-function` — проверка наличия зарегистрированной функции.
- `/keep-alive` — поддержание активности сервера.

### Логирование
Используется библиотека SLF4J для минимизации логов.

### Запуск сервера
```bash
lein run -m my-project.server
```

---

## Клиентская часть

### Основные функции
- **Получение списка доступных серверов**:
  ```clojure
  (get-available-servers)
  ```
  Загружает список серверов из `servers.edn`.

- **Выбор сервера для задачи**:
  ```clojure
  (choose-server func)
  ```
  Возвращает сервер с наименьшей загрузкой.

- **Отправка задачи**:
  ```clojure
  (submit-job func args clojure-code java-object)
  ```
  Отправляет задачу на выполнение на выбранный сервер.

- **Параллельное выполнение `map`**:
  ```clojure
  (parallel-map func args)
  ```
  Выполняет переданные аргументы параллельно на нескольких серверах.

### Примеры использования
- Регистрация функции:
  ```clojure
  (register-remote-function "add" "(fn [a b] (+ a b))")
  ```

- Выполнение удалённой функции:
  ```clojure
  (submit-job 'add [1 2] nil nil)
  ```

- Выполнение `map`:
  ```clojure
  (parallel-map 'add [1 2 3 4 5])
  ```

### Запуск клиента
```bash
lein run -m my-project.client
```

---

## Тестирование

### Модульные тесты
Тесты расположены в пространстве имен `my-project.client-test`.

#### Примеры тестов
- Тест получения доступных серверов:
  ```clojure
  (deftest test-get-available-servers
    (testing "Get available servers"
      (with-redefs [slurp (constantly "[{:id 1 :port 3000 :load 0}]")]
        (let [servers (client/get-available-servers)]
          (is (= 1 (count servers)))
          (is (= 3000 (:port (first servers))))))))
  ```

- Тест выбора сервера:
  ```clojure
  (deftest test-choose-server
    (testing "Choose the best available server"
      (let [servers [{:id 1 :port 3000 :load 1}
                     {:id 2 :port 3001 :load 0}
                     {:id 3 :port 3002 :load 2}]]
        (with-redefs [client/get-available-servers (constantly servers)
                      client/is-server-active? (constantly true)]
          (let [server (client/choose-server 'add)]
            (is (= 3001 (:port server))))))))
  ```

#### Запуск тестов
```bash
lein test
```

---

## Ограничения и рекомендации
1. Система оптимизирована для больших объёмов вычислений.
2. Важно следить за актуальностью файла `servers.edn`.
3. Требуется настройка прав доступа к портам для работы серверов.

---

## Заключение
Проект предоставляет мощный инструмент для распределённых вычислений, позволяя эффективно использовать ресурсы облачной инфраструктуры. Система легко расширяется и поддерживает интеграцию с Java и Clojure-кодом.

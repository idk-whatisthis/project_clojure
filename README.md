# Техническая документация

## Обзор
Этот проект реализует распределённую вычислительную платформу для управления удалённым выполнением функций, балансировки нагрузки и передачи данных. Он поддерживает:

- Прозрачное выполнение операций на удалённых серверах.
- Маршалинг кода и данных.
- Балансировку нагрузки между серверами.
- Параллельное и распределённое выполнение операций `map`.
- Оптимизированную передачу данных.
- Поддержку транспорта Java-объектов и байт-кода Clojure.
- Асинхронное выполнение заданий с мониторингом прогресса.

## Структура проекта

### Модуль API
Модуль API предоставляет интерфейсы для взаимодействия с системой, включая:

1. **Инициализация сервера**: Запуск сервера с использованием `-main`.
2. **Регистрация функций**: Позволяет пользователям регистрировать удалённые функции для выполнения.
   ```clojure
   (defn register-function [name code])
   ```
3. **Вызов удалённых функций**: Интерфейсы для вызова зарегистрированных удалённых функций.
   ```clojure
   (defn call-remote-function [func args])
   ```
4. **Отправка кода на Clojure**: Позволяет выполнять произвольный код Clojure удалённо.
   ```clojure
   (defn submit-clojure-code [code])
   ```
5. **Отправка Java-объектов**: Поддерживает отправку Java-объектов.
   ```clojure
   (defn submit-java-object [java-object])
   ```
6. **Параллельный `map`**: Выполняет функцию параллельно на коллекции аргументов.
   ```clojure
   (defn example-submit-parallel-map [])
   ```

### Модуль клиента
Модуль клиента отвечает за взаимодействие с серверами и отправку заданий:

1. **Выбор сервера**: Читает доступные серверы из `servers.edn` и выбирает оптимальный сервер на основе нагрузки.
   ```clojure
   (defn choose-server [func])
   ```
2. **Отправка заданий**: Отправляет задания на выбранный сервер для выполнения.
   ```clojure
   (defn submit-job [func args clojure-code java-object])
   ```
3. **Регистрация функций**: Отправляет запрос на регистрацию функций на сервере.
   ```clojure
   (defn register-remote-function [name code])
   ```

### Модуль сервера
Модуль сервера выполняет следующие задачи:

1. **Выполнение заданий**: Обрабатывает входящие запросы на выполнение заданий, включая вызовы удалённых функций, выполнение кода и обработку объектов.
2. **Управление функциями**: Регистрирует и хранит удалённые функции для последующих вызовов.
3. **Управление состоянием**: Отслеживает статус заданий и их результаты.

### Модули тестирования
Проект включает модули тестирования для компонентов клиента и сервера:

- **Тесты клиента**: Проверяют выбор сервера, отправку заданий и регистрацию функций.
- **Тесты сервера**: Проверяют выполнение функций, обработку заданий и обновление состояния.

## Примеры использования

### Регистрация удалённой функции
```clojure
(defn example-register-subtract []
  (register-function "subtract" "(fn [a b] (- a b))"))
(example-register-subtract)
```

### Вызов удалённой функции
```clojure
(defn example-call-remote-function []
  (call-remote-function 'add [6 7]))
(example-call-remote-function)
```

### Отправка произвольного кода на Clojure
```clojure
(defn example-submit-clojure-code []
  (submit-clojure-code "(+ 10 2)"))
(example-submit-clojure-code)
```

### Отправка Java-объекта
```clojure
(defn example-submit-java-object []
  (submit-java-object {:name "Alice" :age 30}))
(example-submit-java-object)
```

### Выполнение параллельного `map`
```clojure
(defn example-submit-parallel-map []
  (let [func 'add
        args [1 2 3 4 5]]
    (parallel-map func args)))
(example-submit-parallel-map)
```

## Установка и настройка

1. Установите зависимости:
   ```bash
   lein deps
   ```
2. Запустите сервер:
   ```bash
   lein run -m my-project.server
   ```
3. Настройте файл `servers.edn` с доступными серверами:
   ```edn
   [{:id 1 :port 3000 :load 0}
    {:id 2 :port 3001 :load 0}]
   ```

## Будущие улучшения

1. Улучшенная обработка ошибок и логика повторов.
2. Динамическое обнаружение и настройка серверов.
3. Повышенная безопасность с использованием аутентификации и авторизации.
4. Расширенные возможности мониторинга и логирования.
5. Поддержка дополнительных форматов данных и языков программирования.

## Зависимости

- Clojure 1.11.1
- Ring (Core, Jetty Adapter, JSON)
- Cheshire
- HTTP-Kit
- Core.Async
- clj-http


